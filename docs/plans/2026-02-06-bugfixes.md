# Bugfixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix three issues: restart from beginning after finish, tokenizer error display, mobile pause text view overflow.

**Architecture:** Three independent fixes touching AppState.scala, Main.scala, Components.scala, and index.html. No shared dependencies between fixes.

**Tech Stack:** Scala 3 / Laminar / ScalaJS, CSS

---

### Task 1: Restart from Beginning After Finish

**Files:**
- Modify: `frontend/src/main/scala/rsvpreader/ui/AppState.scala:92-99`

**Step 1: Clear saved position on restart**

In `AppState.scala`, the `togglePlayPause()` method's `Finished` branch (line 95-98) re-sends tokens but doesn't clear `savedPosition`. Add two lines to clear both the in-memory state and localStorage before re-sending tokens:

```scala
def togglePlayPause()(using AllowUnsafe): Unit =
  viewState.now().status match
    case PlayStatus.Playing  => sendCommand(Command.Pause)
    case PlayStatus.Finished =>
      // Clear saved position so engine restarts from beginning
      savedPosition = None
      org.scalajs.dom.window.localStorage.removeItem("rsvp-position")
      // Re-send current tokens to start a fresh playback session
      val tokens = viewState.now().tokens
      _tokensChannel.foreach(_.unsafe.offer(tokens))
    case _ => sendCommand(Command.Resume)
```

**Step 2: Verify**

Run: `sbt frontend/fastLinkJS`
Expected: Compiles successfully.

**Step 3: Commit**

```bash
git add frontend/src/main/scala/rsvpreader/ui/AppState.scala
git commit -m "fix: restart from beginning after text finishes"
```

---

### Task 2: Tokenizer Error Handling

**Files:**
- Modify: `frontend/src/main/scala/rsvpreader/ui/AppState.scala` (add error state)
- Modify: `frontend/src/main/scala/rsvpreader/ui/Components.scala:259-286` (render error)
- Modify: `frontend/src/main/scala/rsvpreader/Main.scala:143-153` (catch errors)

**Step 1: Add error state to AppState**

In `AppState.scala`, add after line 22 (`inputText` declaration):

```scala
val loadError: LaminarVar[Option[String]] = LaminarVar(None)
```

**Step 2: Wrap tokenizer call in try-catch**

In `Main.scala`, replace `onTextLoaded` (lines 143-153):

```scala
private def onTextLoaded(text: String): Unit =
  AppState.loadError.set(None)
  try
    val tokens = Tokenizer.tokenize(text)
    val textHash = text.hashCode
    val startIndex = AppState.savedPosition match
      case Some((hash, idx)) if hash == textHash => idx
      case _ => 0
    AppState.savedPosition = Some((textHash, startIndex))
    println(s"Loaded ${tokens.length} tokens (resuming at $startIndex), sending to engine")
    AppState.unsafeGetTokensChannel.unsafe.offer(tokens)
    ()
  catch
    case ex: Exception =>
      AppState.loadError.set(Some(s"Failed to process text: ${ex.getMessage}"))
```

**Step 3: Render error in text input modal**

In `Components.scala`, in the `textInputModal` method (line 259), add an error message div between the textarea and the button. Replace lines 273-284:

```scala
      ),
      child.maybe <-- AppState.loadError.signal.map {
        case Some(msg) => Some(div(
          cls := "load-error",
          msg
        ))
        case None => None
      },
      button(
        cls := "start-reading-btn",
        "Start Reading",
        onClick --> { _ =>
          val text = AppState.inputText.now()
          if text.trim.nonEmpty then
            onStart(text)
            AppState.showTextInputModal.set(false)
            AppState.saveSettings()
        }
      )
```

**Step 4: Add error CSS**

In `index.html`, add before the `/* Responsive */` comment (line 902):

```css
      .load-error {
        color: #e05050;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        background: rgba(224, 80, 80, 0.1);
        border: 1px solid rgba(224, 80, 80, 0.3);
        border-radius: 6px;
      }
```

**Step 5: Verify**

Run: `sbt frontend/fastLinkJS`
Expected: Compiles successfully.

**Step 6: Commit**

```bash
git add frontend/src/main/scala/rsvpreader/ui/AppState.scala \
        frontend/src/main/scala/rsvpreader/Main.scala \
        frontend/src/main/scala/rsvpreader/ui/Components.scala \
        frontend/index.html
git commit -m "feat: show error message when tokenizing text fails"
```

---

### Task 3: Mobile Pause Text View

**Files:**
- Modify: `frontend/index.html:903-951` (mobile media query)

**Step 1: Add mobile constraint for pause text view**

In `index.html`, inside the `@media (max-width: 600px)` block, add after the `.focus-area` rule (after line 914):

```css
        .pause-text-view {
          max-height: 25vh;
        }
```

**Step 2: Verify**

Run: `sbt frontend/fastLinkJS`
Expected: Compiles successfully (CSS-only change, but verify no regressions).

**Step 3: Commit**

```bash
git add frontend/index.html
git commit -m "fix: constrain pause text view height on mobile screens"
```
